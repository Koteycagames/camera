<script>
  const video = document.getElementById('camera');
  const zoom = document.getElementById('zoom');
  const zoomValue = document.getElementById('zoomValue');
  const zoomIn = document.getElementById('zoomIn');
  const zoomOut = document.getElementById('zoomOut');
  const canvas = document.getElementById('canvas');
  const capture = document.getElementById('capture');

  const planBtn = document.getElementById('planBtn');
  const planModal = document.getElementById('planModal');
  const closePlanModal = document.getElementById('closePlanModal');
  const activateBtn = document.getElementById('activateBtn');
  const activationKey = document.getElementById('activationKey');

  const settingsBtn = document.getElementById('settingsBtn');
  const settingsModal = document.getElementById('settingsModal');
  const closeSettings = document.getElementById('closeSettings');
  const qualitySelect = document.getElementById('qualitySelect');
  const applyQuality = document.getElementById('applyQuality');

  let currentPlan = "def";
  let currentStream = null;
  let currentQuality = 1080;
  let mediaRecorder = null;
  let recordedChunks = [];
  let isRecording = false;

  // üî¥ –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–ø–∏—Å–∏ ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω–æ, –±–µ–∑ –ª–æ–º–∫–∏ —Å—Ç–∏–ª–µ–π
  const recordBtn = document.createElement('button');
  recordBtn.textContent = "‚è∫ –ó–∞–ø–∏—Å—å";
  recordBtn.id = "recordBtn";
  recordBtn.style.background = "#d32f2f";
  recordBtn.style.color = "white";
  recordBtn.style.border = "none";
  recordBtn.style.borderRadius = "50px";
  recordBtn.style.padding = "10px 25px";
  recordBtn.style.fontSize = "16px";
  recordBtn.style.transition = "0.2s";
  document.querySelector('.action-buttons').appendChild(recordBtn);

  async function initCamera(resolution = 1080) {
    try {
      if (currentStream) currentStream.getTracks().forEach(track => track.stop());
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment',
          width: { ideal: resolution * 16 / 9 },
          height: { ideal: resolution }
        },
        audio: true
      });
      video.srcObject = stream;
      currentStream = stream;
    } catch (err) {
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ: ' + err.message);
      console.error(err);
    }
  }

  function updateZoom() {
    const z = parseFloat(zoom.value);
    video.style.setProperty('--zoom', z);
    zoomValue.textContent = `–ó—É–º: ${z.toFixed(1)}√ó`;
  }

  zoom.addEventListener('input', updateZoom);
  zoomIn.addEventListener('click', () => {
    let newZoom = parseFloat(zoom.value) + 0.1;
    if (newZoom > parseFloat(zoom.max)) newZoom = parseFloat(zoom.max);
    zoom.value = newZoom.toFixed(1);
    updateZoom();
  });
  zoomOut.addEventListener('click', () => {
    let newZoom = parseFloat(zoom.value) - 0.1;
    if (newZoom < 1) newZoom = 1;
    zoom.value = newZoom.toFixed(1);
    updateZoom();
  });

  // üì∏ –§–æ—Ç–æ
  capture.addEventListener('click', () => {
    if (!video.videoWidth) return alert('–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞!');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const link = document.createElement('a');
    link.download = 'photo.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  });

  // üé• –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ
  recordBtn.addEventListener('click', () => {
    if (!currentStream) return alert("–ö–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞!");
    if (!isRecording) {
      recordedChunks = [];
      try {
        mediaRecorder = new MediaRecorder(currentStream, { mimeType: 'video/webm; codecs=vp9' });
      } catch (err) {
        alert("–û—à–∏–±–∫–∞: " + err.message);
        return;
      }
      mediaRecorder.ondataavailable = e => e.data.size && recordedChunks.push(e.data);
      mediaRecorder.onstop = saveRecording;
      mediaRecorder.start();

      isRecording = true;
      recordBtn.textContent = "‚èπ –°—Ç–æ–ø";
      recordBtn.style.background = "#b71c1c";
      document.querySelector('.camera-container').style.boxShadow = "0 0 20px 4px red";
    } else {
      mediaRecorder.stop();
      isRecording = false;
      recordBtn.textContent = "‚è∫ –ó–∞–ø–∏—Å—å";
      recordBtn.style.background = "#d32f2f";
      document.querySelector('.camera-container').style.boxShadow = "none";
    }
  });

  function saveRecording() {
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `record_${new Date().toISOString().replace(/[:.]/g, '-')}.webm`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // üí≥ –ü–ª–∞–Ω—ã
  planBtn.addEventListener('click', () => planModal.style.display = 'flex');
  closePlanModal.addEventListener('click', () => planModal.style.display = 'none');

  activateBtn.addEventListener('click', () => {
    const key = activationKey.value.trim().toLowerCase();
    if (!key) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á!');
    const plans = {
      def: { max: 50 },
      min: { max: 100 },
      nevrotik: { max: 500 },
      zuy: { max: 1000, special: true }
    };
    const plan = plans[key];
    if (!plan) return alert('‚õî –ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á');

    currentPlan = key;
    zoom.max = plan.max;
    alert(`‚úÖ –ü–ª–∞–Ω "${key}" –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! (${plan.max}√ó)`);
    document.body.classList.toggle('zuy-mode', plan.special);
    zoom.value = 1;
    updateZoom();
    planModal.style.display = 'none';
    activationKey.value = '';
  });

  // ‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏
  settingsBtn.addEventListener('click', () => settingsModal.style.display = 'flex');
  closeSettings.addEventListener('click', () => settingsModal.style.display = 'none');

  applyQuality.addEventListener('click', async () => {
    const val = parseInt(qualitySelect.value);
    const requiredPlan = qualitySelect.selectedOptions[0].dataset.plan;
    if (requiredPlan && requiredPlan !== currentPlan) {
      alert(`‚õî –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–ª–∞–Ω "${requiredPlan}"`);
      return;
    }
    currentQuality = val;
    alert(`üîß –ö–∞—á–µ—Å—Ç–≤–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${val}p`);
    await initCamera(val);
    settingsModal.style.display = 'none';
  });

  window.addEventListener('click', e => {
    if (e.target === planModal) planModal.style.display = 'none';
    if (e.target === settingsModal) settingsModal.style.display = 'none';
  });

  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    alert('‚ö†Ô∏è –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞ —á–µ—Ä–µ–∑ HTTPS –¥–ª—è —Ä–∞–±–æ—Ç—ã –∫–∞–º–µ—Ä—ã');
  }

  initCamera();
  updateZoom();
</script>
