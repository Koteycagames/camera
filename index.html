<script>
  const video = document.getElementById('camera');
  const zoom = document.getElementById('zoom');
  const zoomValue = document.getElementById('zoomValue');
  const zoomIn = document.getElementById('zoomIn');
  const zoomOut = document.getElementById('zoomOut');
  const canvas = document.getElementById('canvas');
  const capture = document.getElementById('capture');

  const planBtn = document.getElementById('planBtn');
  const planModal = document.getElementById('planModal');
  const closePlanModal = document.getElementById('closePlanModal');
  const activateBtn = document.getElementById('activateBtn');
  const activationKey = document.getElementById('activationKey');

  const settingsBtn = document.getElementById('settingsBtn');
  const settingsModal = document.getElementById('settingsModal');
  const closeSettings = document.getElementById('closeSettings');
  const qualitySelect = document.getElementById('qualitySelect');
  const applyQuality = document.getElementById('applyQuality');

  let currentPlan = "def";
  let currentStream = null;
  let currentQuality = 1080;
  let mediaRecorder = null;
  let recordedChunks = [];
  let isRecording = false;

  // üî¥ –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–ø–∏—Å–∏
  const recordBtn = document.createElement('button');
  recordBtn.textContent = "‚è∫ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å";
  recordBtn.style.background = "#e53935";
  recordBtn.style.color = "white";
  recordBtn.style.borderRadius = "50px";
  recordBtn.style.padding = "10px 25px";
  recordBtn.style.fontSize = "16px";
  recordBtn.style.border = "none";
  recordBtn.style.transition = "background 0.2s";
  document.querySelector('.action-buttons').appendChild(recordBtn);

  // üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã
  async function initCamera(resolution = 1080) {
    try {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment',
          width: { ideal: resolution * 16 / 9 },
          height: { ideal: resolution }
        },
        audio: true
      });
      video.srcObject = stream;
      currentStream = stream;
    } catch (err) {
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ: ' + err.message);
      console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', err);
    }
  }

  // üîç –ó—É–º
  function updateZoom() {
    const z = parseFloat(zoom.value);
    video.style.setProperty('--zoom', z);
    zoomValue.textContent = `–ó—É–º: ${z.toFixed(1)}√ó`;
  }

  zoom.addEventListener('input', updateZoom);
  zoomIn.addEventListener('click', () => {
    let newZoom = parseFloat(zoom.value) + 0.1;
    if (newZoom > parseFloat(zoom.max)) newZoom = parseFloat(zoom.max);
    zoom.value = newZoom.toFixed(1);
    updateZoom();
  });
  zoomOut.addEventListener('click', () => {
    let newZoom = parseFloat(zoom.value) - 0.1;
    if (newZoom < 1) newZoom = 1;
    zoom.value = newZoom.toFixed(1);
    updateZoom();
  });

  // üì∏ –°–Ω–∏–º–æ–∫
  capture.addEventListener('click', () => {
    if (!video.videoWidth) return alert('–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞!');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const link = document.createElement('a');
    link.download = 'photo.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  });

  // üé• –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ
  recordBtn.addEventListener('click', () => {
    if (!currentStream) return alert("–ö–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞!");

    if (!isRecording) {
      recordedChunks = [];
      try {
        mediaRecorder = new MediaRecorder(currentStream, { mimeType: 'video/webm; codecs=vp9' });
      } catch (err) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏: " + err.message);
        return;
      }
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };
      mediaRecorder.onstop = saveRecording;
      mediaRecorder.start();

      isRecording = true;
      recordBtn.textContent = "‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å";
      recordBtn.style.background = "#b71c1c";
      document.querySelector('.camera-container').style.boxShadow = "0 0 25px 5px red";
    } else {
      mediaRecorder.stop();
      isRecording = false;
      recordBtn.textContent = "‚è∫ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å";
      recordBtn.style.background = "#e53935";
      document.querySelector('.camera-container').style.boxShadow = "none";
    }
  });

  // üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∏–¥–µ–æ
  function saveRecording() {
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `record_${new Date().toISOString().replace(/[:.]/g, '-')}.webm`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
  }

  // üí≥ –ü–ª–∞–Ω—ã
  planBtn.addEventListener('click', () => planModal.style.display = 'flex');
  closePlanModal.addEventListener('click', () => planModal.style.display = 'none');

  activateBtn.addEventListener('click', () => {
    const key = activationKey.value.trim().toLowerCase();
    if (!key) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á!');

    if (key === 'def') {
      currentPlan = 'def'; zoom.max = 50;
      alert('‚úÖ –ü–ª–∞–Ω "def" –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! (50√ó)');
      document.body.classList.remove('zuy-mode');
    } else if (key === 'min') {
      currentPlan = 'min'; zoom.max = 100;
      alert('‚úÖ –ü–ª–∞–Ω "min" –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! (100√ó)');
      document.body.classList.remove('zuy-mode');
    } else if (key === 'nevrotik') {
      currentPlan = 'nevrotik'; zoom.max = 500;
      alert('‚úÖ –ü–ª–∞–Ω "nevrotik" –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! (500√ó)');
      document.body.classList.remove('zuy-mode');
    } else if (key === 'zuy') {
      currentPlan = 'zuy'; zoom.max = 1000;
      alert('üíÄ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —É–ª—å—Ç—Ä–∞-–ø–ª–∞–Ω "zuy" (1000√ó)!');
      document.body.classList.add('zuy-mode');
    } else {
      return alert('‚õî –ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á');
    }

    zoom.value = 1;
    updateZoom();
    planModal.style.display = 'none';
    activationKey.value = '';
  });

  // ‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏
  settingsBtn.addEventListener('click', () => settingsModal.style.display = 'flex');
  closeSettings.addEventListener('click', () => settingsModal.style.display = 'none');

  applyQuality.addEventListener('click', async () => {
    const val = parseInt(qualitySelect.value);
    const option = qualitySelect.selectedOptions[0];
    const requiredPlan = option.dataset.plan;

    if (requiredPlan && requiredPlan !== currentPlan) {
      alert(`‚õî –î–ª—è —ç—Ç–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–ª–∞–Ω "${requiredPlan}"`);
      return;
    }

    currentQuality = val;
    alert(`üîß –ö–∞—á–µ—Å—Ç–≤–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${val}p`);
    await initCamera(val);
    settingsModal.style.display = 'none';
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
  window.addEventListener('click', (e) => {
    if (e.target === planModal) planModal.style.display = 'none';
    if (e.target === settingsModal) settingsModal.style.display = 'none';
  });

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    alert('‚ö†Ô∏è –î–ª—è —Ä–∞–±–æ—Ç—ã –∫–∞–º–µ—Ä—ã —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞ —á–µ—Ä–µ–∑ HTTPS (https://)');
  }

  // –°—Ç–∞—Ä—Ç
  initCamera();
  updateZoom();
</script>
